---
import '../styles/global.css';
import Header from '../components/Header.astro';
import { buildI18nSeo } from '../lib/seo';

interface Props {
  title: string;
  description: string;
  noindex?: boolean;
  ogImage?: string;
  lang?: 'sv' | 'en';
}

const { title, description, noindex = false, ogImage } = Astro.props;
const pathname = Astro.url.pathname || '/';
const siteBase = Astro.site?.toString() ?? process.env.SITE_URL;

if (!siteBase) {
  throw new Error('Missing site URL. Set `site` in astro.config.mjs or define SITE_URL.');
}

const seo = buildI18nSeo(siteBase, pathname);
const siteUrl = new URL(siteBase);
const ogImageUrl = ogImage ? new URL(ogImage, siteUrl).toString() : undefined;
const ogLocale = seo.lang === 'sv' ? 'sv_SE' : 'en_US';
const twitterCard = ogImageUrl ? 'summary_large_image' : 'summary';
---

<!DOCTYPE html>
<html lang={seo.lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex,nofollow" />}
    {noindex && <meta name="googlebot" content="noindex,nofollow" />}
    <link rel="canonical" href={seo.canonical} />
    {seo.alternates.map((alternate) => (
      <link rel="alternate" hreflang={alternate.hreflang} href={alternate.href} />
    ))}
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={seo.canonical} />
    <meta property="og:locale" content={ogLocale} />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}
    <script is:inline>
      (() => {
        const stored = localStorage.getItem('theme');
        const prefersLight = window.matchMedia('(prefers-color-scheme: light)').matches;
        const theme = stored === 'light' || stored === 'dark' ? stored : prefersLight ? 'light' : 'dark';
        document.documentElement.dataset.theme = theme;
      })();
    </script>
  </head>
  <body>
    <Header lang={seo.lang} path={pathname} />
    <main class="w-full pb-[6.25rem] md:pb-0">
      <slot />
    </main>
    <footer class="site-footer pb-[5.5rem] md:pb-0">
      <div class="mx-auto flex w-full max-w-6xl flex-col gap-6 px-6 py-10 md:flex-row md:items-end md:justify-between">
        <div>
          <p class="site-footer-title text-lg font-semibold tracking-tight">Mikael Johansson</p>
          <p class="site-footer-text mt-2 max-w-xl text-sm">
            Portfolio inom SEO/Growth engineering, webbutveckling och automation.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <a class="btn-secondary px-4 py-2" href="/kontakt">Kontakt</a>
          <a class="btn-secondary px-4 py-2" href="/sv/cv">CV</a>
        </div>
      </div>
      <div class="site-footer-divider border-t">
        <div class="site-footer-meta mx-auto w-full max-w-6xl px-6 py-4 text-xs">
          &copy; {new Date().getFullYear()} Mikael Johansson.
        </div>
      </div>
    </footer>
    <script is:inline>
      (() => {
        const button = document.getElementById('theme-toggle');
        if (!button) return;

        const icon = button.querySelector('.theme-toggle-icon');
        const label = button.querySelector('.theme-toggle-text');
        const darkLabel = button.getAttribute('data-label-dark') || 'Dark';
        const lightLabel = button.getAttribute('data-label-light') || 'Light';

        const syncButton = () => {
          const current = document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
          button.setAttribute('aria-pressed', current === 'light' ? 'true' : 'false');
          if (icon) icon.textContent = current === 'light' ? '☀' : '☾';
          if (label) label.textContent = current === 'light' ? lightLabel : darkLabel;
        };

        syncButton();

        button.addEventListener('click', () => {
          const current = document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
          const next = current === 'light' ? 'dark' : 'light';
          document.documentElement.dataset.theme = next;
          localStorage.setItem('theme', next);
          syncButton();
        });
      })();
    </script>
    <script is:inline>
      (() => {
        const anchors = document.querySelectorAll('a[href]');
        const { origin } = window.location;

        const isExternalHttp = (href) => {
          try {
            const url = new URL(href, origin);
            return (url.protocol === 'http:' || url.protocol === 'https:') && url.origin !== origin;
          } catch {
            return false;
          }
        };

        anchors.forEach((anchor) => {
          const href = anchor.getAttribute('href');
          if (!href || !isExternalHttp(href)) return;

          anchor.setAttribute('target', '_blank');

          const rel = new Set((anchor.getAttribute('rel') || '').split(/\s+/).filter(Boolean));
          rel.add('nofollow');
          rel.add('noopener');
          rel.add('noreferrer');
          anchor.setAttribute('rel', Array.from(rel).join(' '));
        });
      })();
    </script>
  </body>
</html>

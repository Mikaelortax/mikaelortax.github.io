---
interface Props {
  lang: 'sv' | 'en';
  path: string;
}

const { lang, path } = Astro.props;

const normalizePath = (value: string) => {
  if (!value) return '/';
  const withLeadingSlash = value.startsWith('/') ? value : `/${value}`;
  const collapsed = withLeadingSlash.replace(/\/{2,}/g, '/');
  const withoutTrailing = collapsed.length > 1 ? collapsed.replace(/\/+$/g, '') : collapsed;
  return withoutTrailing || '/';
};

const currentPath = normalizePath(path);

const svToEnMap: Record<string, string> = {
  '/': '/en',
  '/projekt': '/en/projects',
  '/kompetens': '/en/capabilities',
  '/om': '/en/about',
  '/kontakt': '/en/contact',
  '/sv': '/en',
  '/sv/projekt': '/en/projects',
  '/sv/guider': '/en/guides',
  '/sv/om': '/en/about',
  '/sv/cv': '/en/cv',
  '/sv/kontakt': '/en/contact',
};

const enToSvMap: Record<string, string> = Object.fromEntries(
  Object.entries(svToEnMap).map(([svPath, enPath]) => [enPath, svPath.startsWith('/sv') ? svPath.replace(/^\/sv/, '') || '/' : svPath])
);

const toEnglishPath = (pathname: string) => {
  const normalized = normalizePath(pathname);
  if (svToEnMap[normalized]) return svToEnMap[normalized];
  if (normalized.startsWith('/projekt/')) return `/en/projects/${normalized.slice('/projekt/'.length)}`;
  if (normalized.startsWith('/sv/projekt/')) return `/en/projects/${normalized.slice('/sv/projekt/'.length)}`;
  if (normalized.startsWith('/en')) return normalized;
  return '/en';
};

const toSwedishPath = (pathname: string) => {
  const normalized = normalizePath(pathname);
  if (enToSvMap[normalized]) return enToSvMap[normalized];
  if (normalized.startsWith('/en/projects/')) return `/projekt/${normalized.slice('/en/projects/'.length)}`;
  if (normalized.startsWith('/en/')) return `/${normalized.slice('/en/'.length)}`;
  if (normalized === '/en') return '/';
  if (normalized.startsWith('/sv/')) return `/${normalized.slice('/sv/'.length)}`;
  return '/';
};

const svHref = toSwedishPath(currentPath);
const enHref = toEnglishPath(currentPath);

const homeHref = lang === 'sv' ? '/' : '/en';

const desktopNavItems =
  lang === 'sv'
    ? [
        { label: 'Projekt', href: '/projekt' },
        { label: 'Kompetens', href: '/kompetens' },
        { label: 'Om', href: '/om' },
        { label: 'CV', href: '/sv/cv' },
        { label: 'Kontakt', href: '/kontakt' },
      ]
    : [
        { label: 'Projects', href: '/en/projects' },
        { label: 'Capabilities', href: '/en/capabilities' },
        { label: 'About', href: '/en/about' },
        { label: 'CV', href: '/en/cv' },
        { label: 'Contact', href: '/en/contact' },
      ];

const mobileNavItems =
  lang === 'sv'
    ? [
        { label: 'Hem', href: '/' },
        { label: 'Projekt', href: '/projekt' },
        { label: 'Kompetens', href: '/kompetens' },
        { label: 'CV', href: '/sv/cv' },
        { label: 'Kontakt', href: '/kontakt' },
      ]
    : [
        { label: 'Home', href: '/en' },
        { label: 'Projects', href: '/en/projects' },
        { label: 'Skills', href: '/en/capabilities' },
        { label: 'CV', href: '/en/cv' },
        { label: 'Contact', href: '/en/contact' },
      ];

const isSvActive = lang === 'sv';
const isEnActive = lang === 'en';

const isPathActive = (href: string) => {
  const basePath = normalizePath((href || '/').split('#')[0] || '/');

  if (basePath === '/' || basePath === '/en') {
    return currentPath === basePath;
  }

  return currentPath === basePath || currentPath.startsWith(`${basePath}/`);
};
---

<header class="site-header-shell sticky top-0 z-40 backdrop-blur-xl">
  <div class="site-header relative mx-auto flex w-full max-w-6xl items-center justify-between gap-4 px-4 py-4 sm:px-6 md:grid md:grid-cols-[1fr_auto_1fr] md:py-5">
    <a
      href={homeHref}
      class="site-brand text-lg font-semibold tracking-tight transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950 md:justify-self-start md:text-xl"
    >
      Mikael Johansson
    </a>

    <nav aria-label="Main navigation" class="hidden md:block md:justify-self-center">
      <ul class="site-nav-list flex items-center justify-center gap-5 text-sm">
        {desktopNavItems.map((item) => (
          <li>
            <a
              class={`site-nav-link group rounded-lg px-2 py-1 transition duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950 ${
                isPathActive(item.href) ? 'is-active' : ''
              }`}
              href={item.href}
              aria-current={isPathActive(item.href) ? 'page' : undefined}
            >
              <span class="relative pb-0.5">
                {item.label}
                <span class="absolute inset-x-0 -bottom-0.5 h-px scale-x-0 bg-cyan-200/70 transition duration-200 group-hover:scale-x-100"></span>
              </span>
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <div class="flex items-center gap-2 md:justify-self-end md:gap-3">
      <button
        id="theme-toggle"
        type="button"
        class="theme-toggle inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-semibold tracking-wide"
        aria-label={lang === 'sv' ? 'Byt tema' : 'Switch theme'}
        aria-pressed="false"
        data-label-dark={lang === 'sv' ? 'Mörk' : 'Dark'}
        data-label-light={lang === 'sv' ? 'Ljus' : 'Light'}
      >
        <span aria-hidden="true" class="theme-toggle-icon">☾</span>
        <span class="theme-toggle-text">{lang === 'sv' ? 'Mörk' : 'Dark'}</span>
      </button>

      <nav class="language-switch inline-flex items-center gap-1 rounded-full p-1" aria-label="Language switcher">
        <a
          href={svHref}
          class={`language-pill rounded-full px-3 py-1 text-xs font-semibold tracking-wide transition ${
            isSvActive
              ? 'is-active'
              : 'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950'
          }`}
          aria-current={isSvActive ? 'page' : undefined}
          aria-label="Switch language to Swedish"
        >
          SV
        </a>
        <a
          href={enHref}
          class={`language-pill rounded-full px-3 py-1 text-xs font-semibold tracking-wide transition ${
            isEnActive
              ? 'is-active'
              : 'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950'
          }`}
          aria-current={isEnActive ? 'page' : undefined}
          aria-label="Switch language to English"
        >
          EN
        </a>
      </nav>
    </div>
  </div>
</header>

<nav class="mobile-dock md:hidden" aria-label={lang === 'sv' ? 'Mobil meny' : 'Mobile menu'}>
  <ul class="mobile-dock-list">
    {mobileNavItems.map((item) => (
      <li>
        <a
          href={item.href}
          class={`mobile-dock-link ${isPathActive(item.href) ? 'is-active' : ''}`}
          aria-current={isPathActive(item.href) ? 'page' : undefined}
        >
          <span class="mobile-dock-dot" aria-hidden="true"></span>
          <span>{item.label}</span>
        </a>
      </li>
    ))}
  </ul>
</nav>

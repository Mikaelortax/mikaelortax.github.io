---
interface Props {
  lang: 'sv' | 'en';
  path: string;
}

const { lang, path } = Astro.props;

const normalizePath = (value: string) => {
  if (!value) return '/';
  const withLeadingSlash = value.startsWith('/') ? value : `/${value}`;
  const collapsed = withLeadingSlash.replace(/\/{2,}/g, '/');
  const withoutTrailing = collapsed.length > 1 ? collapsed.replace(/\/+$/g, '') : collapsed;
  return withoutTrailing || '/';
};

const currentPath = normalizePath(path);

const svToEnMap: Record<string, string> = {
  '/': '/en',
  '/projekt': '/en/projects',
  '/kompetens': '/en/capabilities',
  '/om': '/en/about',
  '/kontakt': '/en/contact',
  '/sv': '/en',
  '/sv/projekt': '/en/projects',
  '/sv/om': '/en/about',
  '/sv/kontakt': '/en/contact',
};

const enToSvMap: Record<string, string> = Object.fromEntries(
  Object.entries(svToEnMap).map(([svPath, enPath]) => [enPath, svPath.startsWith('/sv') ? svPath.replace(/^\/sv/, '') || '/' : svPath])
);

const toEnglishPath = (pathname: string) => {
  const normalized = normalizePath(pathname);
  if (svToEnMap[normalized]) return svToEnMap[normalized];
  if (normalized.startsWith('/projekt/')) return `/en/projects/${normalized.slice('/projekt/'.length)}`;
  if (normalized.startsWith('/sv/projekt/')) return `/en/projects/${normalized.slice('/sv/projekt/'.length)}`;
  if (normalized.startsWith('/en')) return normalized;
  return '/en';
};

const toSwedishPath = (pathname: string) => {
  const normalized = normalizePath(pathname);
  if (enToSvMap[normalized]) return enToSvMap[normalized];
  if (normalized.startsWith('/en/projects/')) return `/projekt/${normalized.slice('/en/projects/'.length)}`;
  if (normalized.startsWith('/en/')) return `/${normalized.slice('/en/'.length)}`;
  if (normalized === '/en') return '/';
  if (normalized.startsWith('/sv/')) return `/${normalized.slice('/sv/'.length)}`;
  return '/';
};

const svHref = toSwedishPath(currentPath);
const enHref = toEnglishPath(currentPath);

const homeHref = lang === 'sv' ? '/' : '/en';
const navItems =
  lang === 'sv'
    ? [
        { label: 'Projekt', href: '/projekt' },
        { label: 'Kompetens', href: '/kompetens' },
        { label: 'Process', href: '/#process' },
        { label: 'Om', href: '/om' },
        { label: 'Kontakt', href: '/kontakt' },
      ]
    : [
        { label: 'Projects', href: '/en/projects' },
        { label: 'Capabilities', href: '/en/capabilities' },
        { label: 'Process', href: '/en/#process' },
        { label: 'About', href: '/en/about' },
        { label: 'Contact', href: '/en/contact' },
      ];

const isSvActive = lang === 'sv';
const isEnActive = lang === 'en';
---

<header class="sticky top-0 z-40 border-b border-white/10 bg-neutral-950/70 backdrop-blur-md">
  <div class="pointer-events-none absolute inset-x-0 bottom-0 h-px bg-gradient-to-r from-transparent via-cyan-200/20 to-transparent"></div>
  <div class="relative mx-auto flex w-full max-w-5xl flex-col gap-4 px-6 py-6 md:flex-row md:items-center md:justify-between">
    <a href={homeHref} class="text-lg font-semibold text-white transition hover:text-cyan-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950">
      Mikael Johansson
    </a>
    <div class="flex flex-wrap items-center gap-4 md:gap-6">
      <nav aria-label="Main navigation">
        <ul class="flex flex-wrap items-center gap-4 text-sm text-neutral-200">
          {navItems.map((item) => (
            <li>
              <a
                class="rounded-lg px-2 py-1 text-neutral-200 transition duration-200 hover:text-white hover:brightness-110 hover:[&_span]:border-cyan-200/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950"
                href={item.href}
              >
                <span class="border-b border-transparent pb-0.5 transition">{item.label}</span>
              </a>
            </li>
          ))}
        </ul>
      </nav>
      <nav class="inline-flex items-center gap-1 rounded-full border border-neutral-700 p-1" aria-label="Language switcher">
        <a
          href={svHref}
          class={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide transition ${
            isSvActive
              ? 'bg-white text-black'
              : 'text-neutral-200 hover:bg-white/10 hover:text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950'
          }`}
          aria-current={isSvActive ? 'page' : undefined}
          aria-label="Switch language to Swedish"
        >
          SV
        </a>
        <a
          href={enHref}
          class={`rounded-full px-3 py-1 text-xs font-semibold tracking-wide transition ${
            isEnActive
              ? 'bg-white text-black'
              : 'text-neutral-200 hover:bg-white/10 hover:text-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-200/70 focus-visible:ring-offset-2 focus-visible:ring-offset-neutral-950'
          }`}
          aria-current={isEnActive ? 'page' : undefined}
          aria-label="Switch language to English"
        >
          EN
        </a>
      </nav>
    </div>
  </div>
</header>
